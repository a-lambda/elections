---
title: "Elections législatives 2024 (1er et second tour)"
format: html
editor: source
editor_options: 
  chunk_output_type: console
---

[Résultats des élections législatives du 30 juin 2024](https://www.data.gouv.fr/fr/datasets/elections-legislatives-des-30-juin-et-7-juillet-2024-resultats-definitifs-du-1er-tour/)

[Résultats des élections législatives du 7 juillet 2024](https://www.data.gouv.fr/fr/datasets/elections-legislatives-des-30-juin-et-7-juillet-2024-resultats-definitifs-du-2nd-tour/)


```{r}
#| label: load_packages
#| echo: true 
#| warning: false
library(tidyverse)

```

### Vérification des colonnes pourcentages avant suppression

  - récupération du nom des colonnes à considérer
  
```{r}
  
names_pourcentages <- tib |> 
  select(starts_with("%")) |>  
  names()
names_pourcentages

```

::: {.callout-note collapse="false"}

Attention la fonction `round(x, digits = 2` renvoie $53,12$ au lieu de $53,13$ lorsque x vaut $53,125$ par exemple

:::

  - calcul des pourcentages globaux

    1. par rapport aux inscrits 
      
      - "% Votants", "% Abstentions", "% Exprimés/inscrits", "% Blancs/inscrits", "% Nuls/inscrits"
    
    2. par rapport aux votants 
    
      - "% Exprimés/votants", "% Blancs/votants", "% Nuls/votants"


::: {.callout-caution collapse="false"}

Attention, dans la mise en place de la fonction `get_percentages` ne pas oublier de prendre en compte la possibilité que le dénominateur puisse être égal à 0 !!!

Ce qui en l'occurrence s'avère être le cas pour le nombre de votants dans certaines communes hors métropole.

:::

```{r}

get_percentages <- function(tib, result_col, col_num, col_denum, after_col) {
  result <- tib |> 
    mutate(!!result_col := if_else(
      .data[[col_num]] != 0,
      round(100 * (.data[[col_num]]/.data[[col_denum]]), digits = 2),
      0)) %>%
    relocate(!!result_col, .after = after_col)
  return(result)
}

```

- calcul des pourcentages généraux par rapport aux inscrits

```{r}

col_denum <- "Inscrits"
col_num <- c("Votants", "Abstentions", "Exprimés", "Blancs", "Nuls")

after_col <- c(
  "% Votants", "% Abstentions", 
  "% Exprimés/inscrits", "% Blancs/inscrits", "% Nuls/inscrits"
)
result_col <- str_to_lower(after_col)

for (i in 1:5) {
  
  tib <- get_percentages(tib, result_col[i], col_num[i], col_denum, after_col[i])
  
}

```

- calcul des pourcentages par rapport aux votants

```{r}

col_denum <- "Votants"
col_num <- c("Exprimés", "Blancs", "Nuls")
after_col <- c("% Exprimés/votants", "% Blancs/votants", "% Nuls/votants")
result_col <- str_to_lower(after_col)

for (i in 1:3) {
  
  tib <- get_percentages(tib, result_col[i], col_num[i], col_denum, after_col[i])
  
}

```

::: {.callout-note collapse="false"}

Le fait d'utiliser |> au lieu de %>% génère le message suivant :

Avis : Using an external vector in selections was deprecated in tidyselect 1.1.0.
ℹ Please use `all_of()` or `any_of()` instead.
  # Was:
  data %>% select(after_col)

  # Now:
  data %>% select(all_of(after_col))

See <https://tidyselect.r-lib.org/reference/faq-external-vector.html>.

:::

- Calcul des pourcentages par candidat
  
  1. par rapport aux inscrits 
    
    - "% voix/inscrits xx"
      
  2. par rapport aux exprimés
    
    - "% voix/inscrits xx"



```{r}

inscrits <- "Inscrits"
exprimes <- "Exprimés"

# le nombre de candidats à traiter est :
# (total colonnes du fichier initial - 18) / 9
# 
n_col <- (ncol(resultat) - 18) / 9

for (i in 1:n_col) {

  # nom de colonnes existantes servant pour le calcul
  col_voix <- paste("Voix", i)
  col_Voix_sur_inscrits <- paste("% Voix/inscrits", i)
  col_Voix_sur_exprimes <- paste("% Voix/exprimés", i)
  # nom de colonnes calculées
  col_voix_sur_inscrits <- paste("% voix/inscrits", i)
  col_voix_sur_exprimes <- paste("% voix/exprimés", i)
  # insertion des pourcentages voix/inscrits pour chaque parti
  tib <- get_percentages(tib, col_voix_sur_inscrits, col_voix, inscrits, col_Voix_sur_inscrits)
  # insertion des pourcentages voix/exprimés pour chaque parti
  tib <- get_percentages(tib, col_voix_sur_exprimes, col_voix, exprimes, col_Voix_sur_exprimes)

}

```

- vérification des pourcentages présentés par rapport aux pourcentages recalculés
  
```{r}

tib_col_percentages <- tib |> 
  select(starts_with("%"))

indices_cols_to_compare <- seq(1, ncol(tib_col_percentages), by = 2)
indices_calculated_cols <- seq(2, ncol(tib_col_percentages), by = 2)

# calcul de la somme des différences entre % initiaux et % recalculés

diff_cols <-
  map2(indices_cols_to_compare,
       indices_calculated_cols,
       \(x1, x2) {sum(tib_col_percentages[x1] - tib_col_percentages[x2], na.rm = TRUE)}
  ) |> 
  unlist()

max(diff_cols, na.rm = TRUE)

```





- comptabilité du nombre des candidats par commune

```{r}

candidats_par_commune <- tib_final |> 
  group_by(`Code commune`) |> 
  summarize(n = n()) |> 
  group_by(n) |> 
  summarize(total = n())

```

- communes avec au moins 20 candidats 

```{r}

tib_final |> 
  group_by(`Code commune`, `Libellé commune`) |> 
  summarize(n = n()) |> 
  filter(n >= 20) |> 
  arrange(desc(n))


```

# *************************
# la suite est à construire
# *************************

```{r}

tib_final |> 
  filter(str_to_lower(Elu) == "élu") |> 
  select(Nom, Prénom, Nuance) |> 
  group_by(Nuance) |> 
  summarize(n = n()) |> 
  arrange(desc(n))

```

Les données de tib_final sont à comparer avec celles obtenues par Nicolas Lambert
(https://gitlab.huma-num.fr/atlas-social-de-la-france/legislatives-2024)







### Récupération des données sur les partis

```{r}

tib_partis <- tib_without_percentages |> 
  select(matches("[0-9]")) |> 
  select(!starts_with(c("Voix", "Sièges"))) |> 
  unique() |> 
  pivot_longer(
    cols = everything(),
    names_to = c(".value", "Parti"),
    names_pattern = '([a-zà-üA-Z\\s]+) ([0-9]+)'
  )
head(tib_partis)

```

### Jointure entre les données utiles et les données de parti

```{r}

tib_final <- tib_utile |> 
  inner_join(tib_partis)
head(tib_final)

```

### Représentation géographique









